using System.Text.RegularExpressions;

namespace AdventOfCode2023;
internal class DayThree {
	const string _dataSet = "..........................380.......................143............................108.............630...........425........................\r\n....*585..30....217*616..........$...................../....$.................447...........381..................+..........973.............\r\n.210......*...............639...541..-........830*...........912..........743*.......................828..671........+......*...............\r\n.......760....$..............*........737.*.......949..568.......................=........628.85........&.#..........87...535.....794.......\r\n....#......616..........373.999..392......853..........&.........666.......*.....365.............807............@....................*......\r\n.680................800*..............684................329....*.......960.186........725........*......&.....631.....700*818..............\r\n............-402...........%.........@.........576.............956................../.....*....237....490........................998........\r\n........624.........600/...283..906................301....903...........=495.....917..165..193......................................+.......\r\n....977.+........................*........*610.....-....................................*.......489*795.......-....@545..915......*......641\r\n...-.......123........@........113.....643............117.483../...................961.984..................878...........*........277..@...\r\n.............$....787..80....................490......$....../..802.....591...373...*..............228..................848..840............\r\n.613.......................810..........740......476.....902............$..........201......%.......$..-.......993......................701.\r\n......268.......429.........$..........+....582..........@...538*789......................941...136.....334......*.........508...250........\r\n........*...745*.........+......*77.........*......653..................#....27................/......+..........491....#....*...*....192...\r\n.......978.............26....957......*...400.........*834.#85.......429............................291................690...69.814....#....\r\n...276.....=.571....................65....................................765.......179..720..................460.302.......................\r\n...*.....577...*..........................=50..758............/.52@........*..........@..............279........-...........................\r\n..821...........676..839...227..................*..........273...........789...42.288...#.......226......................451..592......943..\r\n.........*...................*......................................$................*..378.......*..876.497....@..575*.........*.....*.....\r\n......524........353........664......781...../108..................124.............407........272.43.#....&..421.......708......../..405....\r\n................*....769.............*.............../.........432..........57$..............*...................=...........887.637........\r\n................96...*................700..%.......573........*....644..........802......798.897.......456..258.130..182......*.............\r\n...........&.........420............#.....369..............121........$....916...*........*...............*.............*637.......*816.....\r\n...911...97....990...................557.......................355............#.578........764.872.........80.....*792..........517.........\r\n.....*..........*...-609....675.............657......728......%....446....963.........201......%.......232.....576.......116........630.....\r\n..801..........352............%..............*..........*422..........*..*........538..*.........*435.*.....................*730.....*......\r\n....................&................952..283.....931...............95...617........%..215....174.........139........375...........755.426..\r\n..........972.......82...500........*.............*...854.......208...........853%..................=......*...........*..941...........%...\r\n....975+.....*.....................58....$..836.899..../.........*...................@682........952........193.......13.*........711.......\r\n............757..............45.......453...../.............603.735......155..848..........402..........954..............530...........%....\r\n..........................................285...........596...=.............*...............*.......*....#......*681...........*162.517.....\r\n.173.589.......892..451......268...........*............../............764...476...........206...860.123.....812.....97*319.139.............\r\n.......*............%....981....*288....917....666..............#.........&.......532@...-...............330.........................731....\r\n......764.......*........*...................=...+.985...952...498..+473.................98..&..663..414....*...885&...788..../.............\r\n.............508.439.....956......799.122..786.............*.............214.................63............346........=......507............\r\n...252*780.......................*....*.....................446............*.....900.540.................................510...........899..\r\n...........169-......%..@........328.506................573.................367.....*..........646.896...815...691..............%141........\r\n.................-.195.606.....&................908......./...67*49...@.........707.....#607......*........*.....=..........................\r\n..902..@......742.............706..355&.....953...*..811...............125..490....*241..............+..468..............512....334.........\r\n...*....463.......802.260&....................*..711.-...-......................%.................360................811.%.............%....\r\n.113............%..*....................%861.999.......458..................334.924..425..406..........184#................712....#.....176.\r\n.........166...689.124......*550.840.......................742................#........%......405...........26.........546*.......665.......\r\n............*............159........*...........@879.......*.........48..................987......751.319....*...113........................\r\n..........163............................................453...524.....$..........*936...*...........*......119..+.......756.......&...326..\r\n777*241.......210.974.258.....528..............................$...............559.......921......@....382...............*........147...*...\r\n....................*.*....................131*156........./................@......445.........477......*.....47=....875..730..........499..\r\n.....682..........545..856............................165..740...831.........368..........851......926...223............*...................\r\n....*.............................447..................@...........*..............%...418....*.....*...........838...325....................\r\n....722.......71....848...747........*..690....275..........740...16..123..129...837.....+.359.68..426......=....-........791...617..582....\r\n.............*............=...271...358.*.........*...................+.......*................*............378............$................\r\n570.......620..399*666...................702.....32...............215..........896.325......377...................=286.................200..\r\n...*833...................................................12/.247......510.........*...369........813*..........*...........................\r\n....................................%..........-......&..........*655....*.......380....*.............778.....98.910.......752..............\r\n.............643.783..............621....777..523.....384..$...........693...............336................................#..+............\r\n521.........*.......*.................$...................261.31..............549.................102......467-.......219......286....$118..\r\n..........837........904..636.298.204..368.......47............/.................*...........246...*....#.......526......*..................\r\n.....201......497............*....*..............*................982........+..243.............*.774....488.......*..641...........140.....\r\n838...*....+.......................296....*765..489....8....................796.......=.......200................996.........364.......*....\r\n.......540.93....+...............................................*600.................47..................256........#..........*...+..823..\r\n................14...-65..................328.............................407+..............54.464..990....*...305..129.......679..141......\r\n.........................487.-.....831.......*.....407.776.409.....75.............426..782...*...*..#......347....*....................864..\r\n....995...................=...117.../..*..531.........*......$.......*973...........*...@......614................194........172...930*.....\r\n.......*386...........................799.....660...................................415....../.....%370...289............988................\r\n.....-..........835+..316.47..............226......904.........789..........................32............$....616..........=...............\r\n...243.....26............*........479%....=....@...=..............*......#.....292..............389.....@.....*...................+...$546..\r\n..........*.....&.......................$....199......@........&..25......345.....*36...626.....*.....632..108..69*362...&561..517..........\r\n.136*291...858...815........974.......913............786....908......495......805..........*122.948.........................................\r\n...........................*...............103*363...............438...........*..@.@...........................%401.......90=......403.....\r\n.313&.618....@...$521.....332............................768.......*.........428.50..445.338.....*.......................%.....115.*........\r\n.......*.....583..............586...........=..............*.......11.......................=.171.280.........140..750...798...&....286..111\r\n.....604..........266......................566....-.....398..238.........499........#...@......................*.....%......................\r\n.........545*739.$............68..337*.........296..............*................694...100......&..............233..........................\r\n.....320................468....-........997......................796...48.....................219.....&............378.552...8..............\r\n.......$..........356+....*................*.........205................/........645*....600.........709.....................*...760........\r\n...625..................681........870-...907.......-....142..173...859..............802...*.....................741..289*74.............705\r\n.........244......908....................................*.../........*..................501......92.............*..........................\r\n............*......$.....576.384..111.119.............127..............720....898....534............*....347........................487*....\r\n....610...922...........$.....*...*..........381*36.........................../.......*......665.843.......*....754.470..690................\r\n.....*.........$..135.......142.242.352..............................775...-.....*....67....*.........+...576......*.....#..................\r\n.....249....735......*.......................................402-...*....903..667.419......526........294...................................\r\n.361.....-......418.659.575......803.596......910....367...........950.....................................308........*.....................\r\n...*......690..*...........*797.................*.......*....................160..........61.....#........*..........141.....402...599..811.\r\n...505..............288%........525%...........355...324.................876*...............*538..39....482..696............@.........*.....\r\n...............401........@............884..........................&.......................................*.........749.............86....\r\n.........484......*38..370........328.*............553......&845.....662................520................46................24.............\r\n.....407*..........................$..310..........*.....................765..672............832.......................@.657....555../..588.\r\n..........107.789..200..213.....................898..545........67...........%................./...........101.742...422..%...=...&.622.....\r\n.............*......*............*292......946......&..............243+.651....178...665............./.........*.............92.............\r\n......974...........814.......220......906......$......*.....879...........*......+.....*........-...995........185.18...........254..198...\r\n...........791..808.....984...............&...985...871.678..*.............340................973..........253.......#..................*...\r\n..../.....*........=....*..........92*411.....................835...................%.................#.../................$.........279....\r\n....926....292...........839...333..........600.115....................=....&.....336.....350........966......999...540..908.............705\r\n................................*...497...........*....994..........447......131.........*...................*..............................\r\n...........$.....-....../.....394...=.......175.417....*................................719...................992....................-......\r\n..........960.698.....610.986.........*776..........516...34......&.....75...751...$........%.......651.....=......300...........364.905....\r\n...317.......................*..+...........................*....783.....*..=......655.......310.....+...339..........*......256*........145\r\n....&..107..................276.136..905......548..%.......334.........471...................................279.727..696...................\r\n343...*......733........515..........$....357....@.301.........*348...................118.........&...439...*.......................922.....\r\n....754.....-......646.@.................-..................929.................475......*......785......*..684..............27......*......\r\n...................*.....463..../59.609...........168*863...................801...&..211..382..........347............28.............473....\r\n.................725.....#...........*......79..........................978*...........*......................199.....*.........579.........\r\n...........................157*662....958...*...............546@.................&..181...416.109..............*....258.....421*............\r\n...859......777=.............................217.862..................817*597...655........*.........76.....443.....................292.....\r\n...@...170..........273...........+..=.............................=................217....253..438....*....................................\r\n.......&.......................971..876...............205.....394.502..122...........$.............$...40............802....................\r\n..894........*.623...718..................216........*.........=.......................544.....................102............932.951..615..\r\n....+......865........*...............................298.721................147.......*.........165.741*794...*......318...&.......*...*...\r\n...................878..........................*.........../............947...........314.......*...........999............493.....996.330.\r\n...........705.........79........994.645.703.203.258...........706...227*..........+............590....822*.................................\r\n.....468..*......*311./...@23...$.....@....................588...*.........317......113....857.............19.#..&260...571...251=....772...\r\n......*..11...175..........................................*....259...509.....*...........*.......443..487....73........................*...\r\n.....161..............................................832...611..........*609..742.........938......*.*............@909.....66.232..........\r\n..........125...............630.....596.......%477.......*........................................601..........158............*......201*864\r\n...................819.......=..-.........................198..............=..........418...60............904...............................\r\n781...663..250...................281....905.+...187....%..............271..852...........=..*...484...517*..................................\r\n.......*......=....865.826...%............&.679..*.....160..576.....................462+...717.............&........389........783....67....\r\n.......988............*......79..441............474.........#.....471.......298................./.....*511.445......*......463*.............\r\n...........91....807.............*......173.............#27.................*......937.353.....85..510..............109.#............70.....\r\n...........*.......*...........955..398...@......75.........*...........32...221../....*....7..........234../481........841.........@.......\r\n........#..593......864.....................932.*........960........160*.............953........385...+.....................................\r\n.702*..596.........................$....952*.....20.........................................257....*........741.858.......*......839..491...\r\n................#........618.....693...............................333*87......173......268*......775..................699.710...*..........\r\n..........985..586...818..*..........*723.......437*..........148...................333........................156.............821.....651..\r\n.....................#...982......360.......757.....706.122....&............245........-........16.......571.......544................$.....\r\n6...381......................657..............#...................112*.....*.....496......388.&....556#.....*428..*................-.....828\r\n........#.398.688.900@..674....*....284.860..........-....................588.............*...47.........@........280............86.........\r\n.....526.....*.............*...........*.....154......267..960......563.......29.......398........309#....849./........240*685..............\r\n.......................692.420.978#.........*.....261.....%........+.........*.....492......$957..............979..................254.691..\r\n...978#...131*980.......+.................925.....*...627......519....368*..324...*..................$..................52............*.....\r\n....................453........400$............................*................745...+..........-..838..#....118.........=.....815.........\r\n....679......796.........920........$...75...290..195.......307...340.....649..........403......165.....26.......*..........711.*...........\r\n....*.........%..100.440.........206....$...*....*...................*254..........990..............249..........380....-.....%.535.........\r\n..........988.....*...*...................399..723.....*....................107......*.....................49...........422.................\r\n...800*......*..183..117..375......375..............807.691........981................890.......622...97.....$.515................@.........\r\n.......413.129...........*.............729....&137...........956....$.....976....................*....../..........................334......\r\n...313..........794-..807.....*698.....&...........874*.........*...............71........................655...............................\r\n.....*.....................193............*547.........459.....338...489..581.......483..@115..125........*..........220....................\r\n....907..361*.....243..834.............987.....149..........@.........*...............*........$.......509..698.142../.....@.=750......4....\r\n....................-...*.....................*............611........21..251.&......578........................*.......717.......47#.......\r\n.........................610.26.............892...............................299............601............721..729........................";
	const string _testSet = "467..114..\r\n...*......\r\n..35..633.\r\n......#...\r\n617*......\r\n.....+.58.\r\n..592.....\r\n......755.\r\n...$.*....\r\n.664.598..";
	const string _symbolRegex = @"[^\w.]";
	const string _numberRegex = "[0-9]+";

	public DayThree() {
		Console.WriteLine("\n*** Day Three ***\n");
		Console.WriteLine("Sum of part numbers: " + PartOne(_dataSet));
		Console.WriteLine("Sum gear ratios: " + PartTwo(_dataSet));
	}

	public static int PartOne(string data) {
		return ExtractPartNumbers(data).Sum();
	}

	public static List<int> ExtractPartNumbers(string data) {
		string[] lines = data.Split("\r\n");
		List<int> res = [];

		for(int i = 0; i < lines.Length; i++) {
			MatchCollection matches = Regex.Matches(lines[i], _numberRegex);

			for(int y = 0; y < matches.Count; y++) {
				int start = matches[y].Index;
				int length = matches[y].Length;
				bool isPartNumber = false;

				if(0 < start) {
					start--;
					length++;
				}

				if(start + length < lines[i].Length) {
					length++;
				}

				isPartNumber |= Regex.Match(lines[i].Substring(start, length), _symbolRegex).Success;

				length--;
					
				isPartNumber |= 0 <= i - 1 && HasRegexInLineBetweenPositions(lines[i - 1], start, length);
				isPartNumber |= i + 1 < lines.Length && HasRegexInLineBetweenPositions(lines[i + 1], start, length);

				if(isPartNumber) {
					res.Add(int.Parse(matches[y].Value));
				}
			}
		}

		return res;
	}

	private static bool HasRegexInLineBetweenPositions(string line, int start, int length) {
		return Regex.Matches(line, _symbolRegex).Select(e => e.Index).Any(index => start <= index && index <= start + length);
	}

	private static int PartTwo(string data) {
		return ExtractGearRatio(data).Sum();
	}

	private static List<int> ExtractGearRatio(string data) {
		string[] lines = data.Split("\r\n");
		List<int> res = [];

		for(int i = 0; i < lines.Length - 1; i++) {
			MatchCollection matches = Regex.Matches(lines[i], "[*]");

			for(int y = 0; y < matches.Count; y++) {
				int position = matches[y].Index;
				List<string> surroundings = [];

				surroundings.AddRange(GetAllSurroundingNumbers(lines[i], position));

				if(0 <= i - 1) {
					surroundings.AddRange(GetAllSurroundingNumbers(lines[i - 1], position));
				}

				if(i + 1 < lines.Length) {
					surroundings.AddRange(GetAllSurroundingNumbers(lines[i + 1], position));
				}

				if(surroundings.Count == 2) {
					res.Add(surroundings.Select(int.Parse).Aggregate((value, acc) => value * acc));
				}
			}
		}

		return res;
	}

	private static IEnumerable<string> GetAllSurroundingNumbers(string line, int position) {
		return Regex.Matches(line, _numberRegex).Where(match => (match.Index >= position - 1 || match.Index + match.Length - 1 >= position - 1) && (match.Index <= position + 1 || match.Index + match.Length <= position)).Select(e => e.Value);
	}
}
